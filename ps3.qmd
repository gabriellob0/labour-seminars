---
title: "Applied Problem Set III"
format: revealjs
---

```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(haven)
library(binsreg)
library(broom)
library(lmtest)
library(sandwich)
library(gghighlight)
```

# Question 1

What is the expression for indirect utility $V(w, r, s)$? What is the expression for total costs $C(w, r, Z)$
and unit costs $c(w, r, Z)$?

## Utility maximisation

Workers choose how much to consume of a private good $x$ and land $l^c$ to maximise utility subject to a budget constraint.

$$
\begin{aligned}
&max_{x, l^c} \; u(x, l^c, s) \quad \text{s.t.} \quad x + rl^c = w + I \\[10pt]
& \text{where:} \\
& \quad s \text{ is amenities} \\
& \quad r \text{ is rents} \\
& \quad w \text{ is wages} \\
& \quad I \text{ is other income}
\end{aligned}
$$

## Utility maximisation

We assume utility has form $s^{\theta_W} x^\gamma (l^c)^{1-\gamma}$, where $\theta_W$ and $\gamma$ are exogenous parameters. The dual problem is:

$$
\begin{aligned}
&\mathcal{L} = s^{\theta_W} x^\gamma (l^c)^{1-\gamma} - \lambda(x + rl^c - w - I) \\[10pt]
&\text{FOCs:} \\[5pt]
& \quad \frac{\partial{\mathcal{L}}}{\partial{x}} = 0 \implies s^{\theta_W} \gamma x^{\gamma-1} (l^c)^{1-\gamma} = \lambda \\
& \quad \frac{\partial{\mathcal{L}}}{\partial{l^c}} = 0 \implies s^{\theta_W} (1-\gamma) x^\gamma (l^c)^{-\gamma} = \lambda r
\end{aligned}
$$

## Utility maximisation

We obtain the Marshallian demands by dividing the FOCs and replacing them in the budget constraint.

$$
\begin{aligned}
x(w, r) &= \gamma(w + I) \\
l^c(w, r) &= \frac{1}{r}(1-\gamma)(w+I)
\end{aligned}
$$

Which we can replace in the utility function to obtain the indirect utility

$$
V(w, r, s) = \gamma^\gamma (1-\gamma)^{1-\gamma} s^{\theta_W} (w + I) r^{\gamma-1}.
$$

## Cost minimisation

Firms have a production technology $Z N^\alpha (L^p)^{1-\alpha}$, where $Z$ is a production shifter, $N$ is the number of workers, and $L^p$ is the amount of land. They solve the cost minimisation problem

$$
min_{N, L^p} \; wN + rL^p \quad \text{s.t.} \quad Z N^\alpha (L^p)^{1-\alpha} = X
$$

and, as before,

$$
\mathcal{L} = wN + rL^p - \lambda(Z N^\alpha (L^p)^{1-\alpha} - X).
$$

## Cost minimisation

$$
\begin{aligned}
&\text{FOCs:}\\[5pt]
& \quad \frac{\partial{\mathcal{L}}}{\partial{N}} = 0 \implies w = \lambda Z \alpha N^{\alpha-1} (L^p)^{1-\alpha} \\
& \quad \frac{\partial{\mathcal{L}}}{\partial{L^p}} = 0 \implies r = \lambda Z (1-\alpha) N^\alpha (L^p)^{-\alpha}
\end{aligned}
$$

## Cost minimisation

We obtain the factor demands by dividing the FOCs and replacing them in the constraint.

$$
\begin{aligned}
N(w, r) &= \frac{X}{Z} \left[ \frac{r}{w} \left( \frac{\alpha}{1-\alpha} \right) \right]^{1-\alpha} \\
L^p(w, r) &= \frac{X}{Z} \left[ \frac{w}{r} \left( \frac{1-\alpha}{\alpha} \right) \right]^\alpha
\end{aligned}
$$

## Cost minimisation

We plug the factor demands into the objective function to obtain the cost function

$$
C(X, w, r, Z) = \frac{X}{Z} \left(\frac{w}{\alpha}\right)^\alpha \left(\frac{r}{1-\alpha}\right)^{1-\alpha},
$$

which we can divide by $X$ to get the per-unit cost

$$
c(w, r, Z) = \frac{1}{Z} \left(\frac{w}{\alpha}\right)^\alpha \left(\frac{r}{1-\alpha}\right)^{1-\alpha}.
$$

# Question 2

Please graph the expressions for indirect utility and unit costs with $w$ on the y-axis and $r$ on the
x-axis. Please label equilibrium wages and rents and explain the intuition for the slope of the two
curves.

## Indifference conditions

Given a perfectly competitive market for the unit price good, firms must have zero profits in equilibrium.

$$
c(w, r, Z) = 1
$$

Similarly, since workers are perfectly mobile, the indirect utility will be the same across locations.

$$
V(w, r, s) = V^0
$$

## Equilibrium

```{r}
make_plot_data <- function(prod = 0.8) {
  indirect_utility <- function(r, w, s = 0.5) {
    gam <- 0.2
    theta <- 0.1
    (gam^gam) * ((1-gam)^(1-gam)) * (s^theta) * w * (r^(gam-1))
  }
  
  unit_cost <- function(r, w, Z = prod) {
    alp <- 0.2
    1/Z * ((w/alp)^alp) * ((r/(1-alp))^(1-alp))
  }
  
  rents <- seq(0.1, 1, by = 0.01)
  wages <- seq(0.1, 1, by = 0.01)
  
  grid <- expand_grid(rent = rents, wage = wages) |>
    mutate(
      v = indirect_utility(rent, wage),
      c = unit_cost(rent, wage)
    )
  
  cost_contour <- grid |>
    filter(abs(c-1) < 0.01) |>
    select(rent, wage) |>
    mutate(contour_type = "Unit Cost")
  
  utility_contour <- grid |>
    mutate(mv = median(v), contour_type = "Indirect Utility") |>
    filter(abs(v-mv) < 0.01) |>
    select(rent, wage, contour_type)
  
  bind_rows(cost_contour, utility_contour)
}

q2_data <- make_plot_data()
```

```{r}
#| fig-cap: "Note: Contours for α = γ = 0.2, θW = 0.1, s = 0.5, and Z = 0.8"
ggplot(q2_data, aes(x = rent, y = wage, colour = contour_type)) +
  geom_smooth(se = FALSE, linewidth = 1.6) +
  theme_minimal() +
  scale_colour_viridis_d(name = "Contour Line") +
  labs(
    x = "Rent (r)",
    y = "Wage (w)"
  ) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(hjust = 0, size = 9),
    legend.position = "bottom"
  ) +
  annotate("text", x = 0.9, y = 0.25, label = "c(r,w, Z) = 1", size = 5, parse = FALSE) +
  annotate("text", x = 0.9, y = 0.95, label = "V(r,w,s) = 0.5", size = 5, parse = FALSE)
```

# Question 3

If productivity $Z$ increases to $Z'$, what would happen to the unit cost curve and to wages and rental
costs in equilibrium?

## Productivity shift

```{r}
q3_data <- make_plot_data(1) |>
  filter(contour_type == "Unit Cost") |>
  mutate(contour_type = "New Isocost") |>
  bind_rows(q2_data) |>
  mutate(
    contour_type = if_else(contour_type == "Unit Cost", "Old Isocost", contour_type)
  )
```

```{r}
ggplot(q3_data, aes(x = rent, y = wage, colour = contour_type)) +
  geom_smooth(se = FALSE, linewidth = 1.6) +
  theme_minimal() +
  scale_colour_viridis_d(name = "Contour Line") +
  labs(
    x = "Rent (r)",
    y = "Wage (w)"
  ) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(hjust = 0, size = 9),
    legend.position = "bottom"
  )
```

# Question 4

If a strictly positive profit tax $\tau$ were introduced so that $Z' = Z(1−\tau)$, what would happen to the
unit cost curve and to wages and rental costs in equilibrium?

## Equilibrium

TODO: but same thing as before but shifting towards origin, right?

Might be cool to write a function to calculate the equlibrium point and plot that as function of tau.

# Question 5

Analytically and intuitively, what governs how much wages respond to the profit tax?

## Derivation

TODO: total derivative of the cost function w.r.t. Z?

# Question 6

Open the dataset PS3.dta and use binscatter to show the relationship between local area wages and
population shares. Specifically, plot mean wages for population share bins using the following command “binscatter
wages popshare” where popshare is the share of the total US population in that local area.

## Binscatter

```{r}
df <- read_dta("data/PS3.dta")
```

```{r}
#| results: hide
#| fig-cap: "TODO add the catanneo source, explaining binning"
binsreg(df$wages, df$popshare, polyreg = 1)
```

# Question 7

Run the following regression and save the residual:

$$
\log{w_c} = \beta_0 + \beta_1 \log{r_c} + A_c
$$

where log $w_c$ is log wages and log $r_c$ is local rents. Try to make the wage and rent terms economically
comparable.

## Regression coefficients

```{r}
#| fig-cap: "Heteroskedascity-consistent standard errors"
reg_data <- df |>
  mutate(mwages = wages * 160)

model <- lm(log(mwages) ~ log(rent), reg_data)
```

```{r}
model |>
  coeftest(vcov = vcovHC) |>
  tidy() |>
  knitr::kable()
```

# Question 8

List the top 10 local areas by $\hat{A_c}$, which equals $(\log{w_c} - \hat{\beta_0} - \hat{\beta_1} \log{r_c})$.

## Top PUMAs by residual {.scrollable}

```{r}
residuals <- model |>
  augment(data = reg_data)

top_residuals <- residuals |>
  arrange(desc(.resid)) |>
  slice_head(n = 10)

top_residuals |>
  select(pumaname, .resid) |>
  knitr::kable()
```

# Question 9

Create a scatter plot that shows where local areas lie on the graph of $\hat{A_c}$ on the y-axis and wages
$w_c$ on the x-axis. Please superimpose the best fit line. Why do you think some cities fall above and
below the best fit line? Please repeat this analysis but with population shares on the x-axis.

## TODO

I am really not sure what means by line of best fit here? Linear of Ahat on w? Or something related to the regression?

## Wages scatter plot

```{r}
ggplot(residuals, aes(mwages, .resid)) +
  geom_point() +
  gghighlight(pumaname %in% top_residuals$pumaname) +
  geom_smooth(method = 'lm', se = FALSE, data = residuals) +
  theme_minimal() +
  labs(
    x = "Wage (monthly)",
    y = "Residual"
  )
```

## Population shares scatter plot

```{r}
ggplot(residuals, aes(popshare, .resid)) +
  geom_point() +
  gghighlight(pumaname %in% top_residuals$pumaname) +
  geom_smooth(method = 'lm', se = FALSE, data = residuals) +
  theme_minimal() +
  labs(
    x = "Population share",
    y = "Residual"
  )
```

# Question 10

Regress $\hat{A_c}$ on the three tax rate variables for sales, income, and corporate taxes. Run bivariate
regressions and then include all three tax rates in the same regression. Please describe and interpret
the sign and magnitudes of the coefficients. How do these coefficients compare to the relationship
between $\hat{A_c}$ and other amenity measures in the dataset?

## Regression coefficients

Need to run 4 regs, prob do a specs with map lm into coeftest and broom.

```{r}
resid_model <- lm(.resid ~ t_sales + t_pinc + t_corp, data = residuals)
```
